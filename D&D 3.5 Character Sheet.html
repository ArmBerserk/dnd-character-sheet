<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D&D 3.5 — Лист персонажа</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
    });
  </script>
  <style>
    :root {
      --bg-dark: #111827;
      --bg-card: #1f2937;
      --border-amber: #b45309;
      --text-amber: #fbbf24;
      --text-blue: #60a5fa;
      --text-green: #34d399;
      --text-purple: #c084fc;
      --text-red: #f87171;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: #e2e8f0;
      padding: 16px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    h1 {
      font-size: 2.25rem;
      background: linear-gradient(to right, #fbbf24, #ef4444);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 0.95rem;
    }

    .card {
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(180, 83, 9, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      backdrop-filter: blur(4px);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.25rem;
      margin-bottom: 16px;
      color: var(--text-amber);
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid-cols-1 { grid-template-columns: 1fr; }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }

    @media (max-width: 768px) {
      .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-6 {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 0.875rem;
      color: #cbd5e1;
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #111827;
      color: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--text-amber);
    }

    .ability-box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .ability-name {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 8px;
      text-transform: capitalize;
    }

    .ability-total {
      font-size: 1.25rem;
      font-weight: bold;
      color: white;
    }

    .ability-mod {
      font-size: 0.875rem;
      color: var(--text-blue);
    }

    .progress-bar {
      height: 6px;
      background: #374151;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #fbbf24, #f59e0b);
      transition: width 0.3s ease;
    }

    .skill-item {
      padding: 12px;
      border-radius: 8px;
      background: #1e293b;
      border: 1px solid #334155;
    }

    .skill-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .skill-value {
      font-weight: bold;
      color: var(--text-green);
    }

    .skill-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #374155;
      color: white;
      cursor: pointer;
    }

    .btn:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: #dc2626;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-success {
      background: #16a34a;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .item-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .item-row > *:not(:last-child) {
      flex: 1;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>D&D 3.5 Character Sheet</h1>
      <p class="subtitle">Создано по правилам Player's Handbook 3.5</p>
    </header>

    <!-- Character Info -->
    <div class="card">
      <div class="grid grid-cols-2" id="charInfo"></div>
    </div>

    <!-- Abilities -->
    <div class="card">
      <h2 class="card-title"><i data-lucide="zap"></i> Ability Scores</h2>
      <div class="grid grid-cols-6" id="abilitiesGrid"></div>
    </div>

    <!-- XP Progress -->
    <div class="card">
      <h2 class="card-title"><i data-lucide="trending-up"></i> Experience</h2>
      <div>
        <label>Current XP: <span id="currentXP">0</span></label>
        <div class="progress-bar">
          <div class="progress-fill" id="xpProgress" style="width: 0%"></div>
        </div>
        <p class="mt-2 text-sm text-gray-400">Level: <span id="currentLevel">1</span> | To next: <span id="xpToNext">1000</span></p>
      </div>
    </div>

    <!-- Skills -->
    <div class="card">
      <h2 class="card-title"><i data-lucide="target"></i> Skills</h2>
      <div class="grid grid-cols-3" id="skillsGrid"></div>
    </div>

    <!-- Feats -->
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title"><i data-lucide="award"></i> Feats</h2>
        <button class="btn btn-success" id="addFeatBtn">
          <i data-lucide="plus"></i> Add Feat
        </button>
      </div>
      <div id="featsList"></div>
    </div>

    <!-- Weapons -->
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title"><i data-lucide="sword"></i> Weapons</h2>
        <button class="btn btn-success" id="addWeaponBtn">
          <i data-lucide="plus"></i> Add Weapon
        </button>
      </div>
      <div id="weaponsList"></div>
    </div>

    <!-- Inventory -->
    <div class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title"><i data-lucide="package"></i> Inventory</h2>
        <button class="btn btn-success" id="addInventoryBtn">
          <i data-lucide="plus"></i> Add Item
        </button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label>Head</label>
          <textarea id="inventoryHead"></textarea>
        </div>
        <div>
          <label>Neck</label>
          <textarea id="inventoryNeck"></textarea>
        </div>
        <div>
          <label>Body</label>
          <textarea id="inventoryBody"></textarea>
        </div>
        <div>
          <label>Hands</label>
          <textarea id="inventoryHands"></textarea>
        </div>
        <div>
          <label>Feet</label>
          <textarea id="inventoryFeet"></textarea>
        </div>
        <div>
          <label>Other / Bag</label>
          <textarea id="inventoryOther"></textarea>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card">
      <h2 class="card-title"><i data-lucide="book-open"></i> Notes</h2>
      <textarea id="notes" placeholder="Заметки, заклинания, особые способности..."></textarea>
    </div>
  </div>

  <script>
    // === DATA ===
    const raceBonuses = {
      'Human': { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0, skillBonus: 1 },
      'Elf': { str: 0, dex: 2, con: -2, int: 0, wis: 0, cha: 0, skillBonus: 0 },
      'Dwarf': { str: 0, dex: -2, con: 2, int: 0, wis: 0, cha: 0, skillBonus: 0 },
      'Half-Elf': { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0, skillBonus: 1 },
      'Halfling': { str: -2, dex: 2, con: 0, int: 0, wis: 0, cha: 0, skillBonus: 0 },
      'Gnome': { str: -2, dex: 0, con: 0, int: 0, wis: 0, cha: 2, skillBonus: 0 }
    };

    const classSkills = {
      'Fighter': ['Climb', 'Craft', 'Handle Animal', 'Intimidate', 'Jump', 'Ride', 'Swim'],
      'Rogue': ['Appraise', 'Balance', 'Bluff', 'Climb', 'Craft', 'Decipher Script', 'Diplomacy', 'Disable Device', 'Disguise', 'Escape Artist', 'Forgery', 'Gather Information', 'Hide', 'Intimidate', 'Jump', 'Knowledge', 'Listen', 'Move Silently', 'Open Lock', 'Perform', 'Profession', 'Search', 'Sense Motive', 'Sleight of Hand', 'Spot', 'Swim', 'Tumble', 'Use Magic Device', 'Use Rope'],
      'Wizard': ['Concentration', 'Craft', 'Decipher Script', 'Knowledge', 'Profession', 'Spellcraft'],
      'Cleric': ['Concentration', 'Craft', 'Diplomacy', 'Heal', 'Knowledge', 'Profession', 'Spellcraft'],
      'Barbarian': ['Climb', 'Craft', 'Handle Animal', 'Intimidate', 'Jump', 'Listen', 'Ride', 'Survival', 'Swim'],
      'Bard': ['Appraise', 'Balance', 'Bluff', 'Climb', 'Concentration', 'Craft', 'Decipher Script', 'Diplomacy', 'Disable Device', 'Disguise', 'Escape Artist', 'Forgery', 'Gather Information', 'Hide', 'Jump', 'Knowledge', 'Listen', 'Move Silently', 'Perform', 'Profession', 'Ride', 'Search', 'Sense Motive', 'Sleight of Hand', 'Speak Language', 'Spellcraft', 'Spot', 'Swim', 'Tumble', 'Use Magic Device', 'Use Rope'],
      'Druid': ['Concentration', 'Craft', 'Diplomacy', 'Handle Animal', 'Heal', 'Knowledge', 'Listen', 'Profession', 'Ride', 'Spellcraft', 'Spot', 'Survival', 'Swim'],
      'Monk': ['Balance', 'Climb', 'Concentration', 'Craft', 'Diplomacy', 'Escape Artist', 'Hide', 'Jump', 'Knowledge', 'Listen', 'Move Silently', 'Perform', 'Profession', 'Sense Motive', 'Spot', 'Swim', 'Tumble'],
      'Paladin': ['Concentration', 'Craft', 'Diplomacy', 'Handle Animal', 'Heal', 'Knowledge', 'Profession', 'Ride', 'Sense Motive', 'Spot'],
      'Ranger': ['Climb', 'Concentration', 'Craft', 'Handle Animal', 'Heal', 'Hide', 'Jump', 'Knowledge', 'Listen', 'Move Silently', 'Profession', 'Ride', 'Search', 'Spot', 'Survival', 'Swim', 'Use Rope']
    };

    const universalSkills = [
      'Balance', 'Climb', 'Concentration', 'Craft', 'Escape Artist', 'Hide', 'Jump',
      'Listen', 'Move Silently', 'Profession', 'Ride', 'Search', 'Spot', 'Survival', 'Swim', 'Tumble'
    ];

    const allSkills = [
      'Appraise', 'Balance', 'Bluff', 'Climb', 'Concentration', 'Craft', 'Decipher Script', 'Diplomacy',
      'Disable Device', 'Disguise', 'Escape Artist', 'Forgery', 'Gather Information', 'Handle Animal',
      'Heal', 'Hide', 'Intimidate', 'Jump', 'Knowledge', 'Listen', 'Move Silently', 'Open Lock',
      'Perform', 'Profession', 'Ride', 'Search', 'Sense Motive', 'Sleight of Hand', 'Speak Language',
      'Spellcraft', 'Spot', 'Survival', 'Swim', 'Tumble', 'Use Magic Device', 'Use Rope'
    ];

    const xpTable = {
      1: 0, 2: 1000, 3: 3000, 4: 6000, 5: 10000, 6: 15000, 7: 21000, 8: 28000, 9: 36000, 10: 45000,
      11: 55000, 12: 66000, 13: 78000, 14: 91000, 15: 105000, 16: 120000, 17: 136000, 18: 153000, 19: 171000, 20: 190000
    };

    const availableFeats = [
      'Acrobatic', 'Alertness', 'Ambidextrous', 'Armor Proficiency (Light)', 'Armor Proficiency (Medium)', 
      'Armor Proficiency (Heavy)', 'Blind-Fight', 'Combat Casting', 'Combat Reflexes', 'Dodge', 'Endurance', 
      'Eschew Materials', 'Exotic Weapon Proficiency', 'Great Fortitude', 'Improved Initiative', 'Iron Will', 
      'Lightning Reflexes', 'Martial Weapon Proficiency', 'Mounted Combat', 'Point Blank Shot', 'Run', 
      'Skill Focus', 'Spell Focus', 'Stealthy', 'Toughness', 'Weapon Focus', 'Weapon Proficiency (Simple)', 
      'Weapon Proficiency (Martial)', 'Weapon Specialization'
    ];

    // === STATE ===
    let state = {
      name: '',
      player: '',
      race: 'Human',
      class: 'Fighter',
      level: 1,
      experience: 0,
      alignment: 'Neutral',
      abilities: { strength: 10, dexterity: 10, constitution: 10, intelligence: 10, wisdom: 10, charisma: 10 },
      tempModifiers: { strength: 0, dexterity: 0, constitution: 0, intelligence: 0, wisdom: 0, charisma: 0 },
      skills: allSkills.reduce((acc, s) => ({ ...acc, [s]: { ranks: 0, misc: 0 } }), {}),
      feats: [''],
      weapons: [{ name: '', damage: '', critical: '', strengthBonus: true, attackMisc: 0, damageMisc: 0 }],
      inventory: {
        head: '',
        neck: '',
        body: '',
        hands: '',
        feet: '',
        other: ''
      },
      notes: ''
    };

    // === HELPERS ===
    function calculateModifier(score) {
      return Math.floor((score - 10) / 2);
    }

    function getTotalAbilities() {
      const raceBonus = raceBonuses[state.race] || {};
      return {
        strength: state.abilities.strength + (raceBonus.str || 0) + state.tempModifiers.strength,
        dexterity: state.abilities.dexterity + (raceBonus.dex || 0) + state.tempModifiers.dexterity,
        constitution: state.abilities.constitution + (raceBonus.con || 0) + state.tempModifiers.constitution,
        intelligence: state.abilities.intelligence + (raceBonus.int || 0) + state.tempModifiers.intelligence,
        wisdom: state.abilities.wisdom + (raceBonus.wis || 0) + state.tempModifiers.wisdom,
        charisma: state.abilities.charisma + (raceBonus.cha || 0) + state.tempModifiers.charisma
      };
    }

    function getAbilityModifiers() {
      const totals = getTotalAbilities();
      return {
        strength: calculateModifier(totals.strength),
        dexterity: calculateModifier(totals.dexterity),
        constitution: calculateModifier(totals.constitution),
        intelligence: calculateModifier(totals.intelligence),
        wisdom: calculateModifier(totals.wisdom),
        charisma: calculateModifier(totals.charisma)
      };
    }

    function getSkillType(skill) {
      const classSkillsList = classSkills[state.class] || [];
      if (classSkillsList.includes(skill)) return 'class';
      if (universalSkills.includes(skill)) return 'universal';
      return 'restricted';
    }

    function getTotalSkillPoints() {
      const mods = getAbilityModifiers();
      const raceBonus = (raceBonuses[state.race] || {}).skillBonus || 0;
      const perLevel = Math.max(1, mods.intelligence + raceBonus);
      return perLevel * 4 + (state.level - 1) * perLevel;
    }

    function getUsedSkillPoints() {
      let total = 0;
      allSkills.forEach(skill => {
        const data = state.skills[skill];
        const type = getSkillType(skill);
        if (data.ranks > 0) {
          total += type === 'class' ? data.ranks : data.ranks * 2;
        }
      });
      return total;
    }

    function calculateLevelFromXP(xp) {
      for (let lvl = 20; lvl >= 1; lvl--) {
        if (xp >= xpTable[lvl]) return lvl;
      }
      return 1;
    }

    // === RENDER ===
    function renderCharInfo() {
      const fields = [
        { key: 'name', label: 'Имя персонажа' },
        { key: 'player', label: 'Игрок' },
        { key: 'race', label: 'Раса', type: 'select', options: Object.keys(raceBonuses) },
        { key: 'class', label: 'Класс', type: 'select', options: Object.keys(classSkills) },
        { key: 'level', label: 'Уровень', type: 'number', min: 1, max: 20 },
        { key: 'alignment', label: 'Мировоззрение' }
      ];

      const container = document.getElementById('charInfo');
      container.innerHTML = '';
      fields.forEach(field => {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.textContent = field.label;
        const input = document.createElement(field.type === 'select' ? 'select' : 'input');
        input.id = field.key;
        if (field.type === 'number') {
          input.type = 'number';
          input.min = field.min;
          input.max = field.max;
        }
        if (field.options) {
          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            input.appendChild(option);
          });
        }
        input.value = state[field.key];
        input.addEventListener('input', (e) => {
          if (field.type === 'number') {
            state[field.key] = Math.min(field.max, Math.max(field.min, parseInt(e.target.value) || 1));
          } else {
            state[field.key] = e.target.value;
          }
          renderAll();
        });
        div.appendChild(label);
        div.appendChild(input);
        container.appendChild(div);
      });

      // Experience field
      const xpDiv = document.createElement('div');
      xpDiv.className = 'md:col-span-2';
      const xpLabel = document.createElement('label');
      xpLabel.textContent = 'Опыт';
      const xpInput = document.createElement('input');
      xpInput.type = 'number';
      xpInput.value = state.experience;
      xpInput.addEventListener('input', (e) => {
        const xp = Math.max(0, parseInt(e.target.value) || 0);
        state.experience = xp;
        state.level = calculateLevelFromXP(xp);
        renderAll();
      });
      xpDiv.appendChild(xpLabel);
      xpDiv.appendChild(xpInput);
      container.appendChild(xpDiv);
    }

    function renderAbilities() {
      const container = document.getElementById('abilitiesGrid');
      container.innerHTML = '';
      const totals = getTotalAbilities();
      const modifiers = getAbilityModifiers();
      const raceBonus = raceBonuses[state.race] || {};

      Object.entries(state.abilities).forEach(([ability, score]) => {
        const box = document.createElement('div');
        box.className = 'ability-box';
        const name = document.createElement('div');
        name.className = 'ability-name';
        name.textContent = ability;
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 3;
        input.max = 18;
        input.value = score;
        input.addEventListener('input', (e) => {
          state.abilities[ability] = Math.min(18, Math.max(3, parseInt(e.target.value) || 10));
          renderAll();
        });
        const race = document.createElement('div');
        race.className = 'text-xs text-gray-400';
        const rb = raceBonus[ability.slice(0,3)] || 0;
        race.textContent = `Раса: ${rb >= 0 ? '+' : ''}${rb}`;
        const total = document.createElement('div');
        total.className = 'ability-total';
        total.textContent = totals[ability];
        const mod = document.createElement('div');
        mod.className = 'ability-mod';
        mod.textContent = modifiers[ability] >= 0 ? `+${modifiers[ability]}` : `${modifiers[ability]}`;
        box.appendChild(name);
        box.appendChild(input);
        box.appendChild(race);
        box.appendChild(total);
        box.appendChild(mod);
        container.appendChild(box);
      });
    }

    function renderXP() {
      document.getElementById('currentXP').textContent = state.experience.toLocaleString();
      document.getElementById('currentLevel').textContent = state.level;
      const nextXP = state.level < 20 ? xpTable[state.level + 1] : null;
      const toNext = nextXP ? nextXP - state.experience : 0;
      document.getElementById('xpToNext').textContent = toNext > 0 ? toNext.toLocaleString() : 'Max';
      const currentLevelXP = xpTable[state.level];
      const progress = nextXP ? ((state.experience - currentLevelXP) / (nextXP - currentLevelXP)) * 100 : 100;
      document.getElementById('xpProgress').style.width = `${Math.min(100, progress)}%`;
    }

    function renderSkills() {
      const container = document.getElementById('skillsGrid');
      container.innerHTML = '';
      const modifiers = getAbilityModifiers();
      const totalPoints = getTotalSkillPoints();
      const usedPoints = getUsedSkillPoints();

      allSkills.forEach(skill => {
        const skillData = state.skills[skill];
        const type = getSkillType(skill);
        const isRestricted = type === 'restricted';
        const isClass = type === 'class';
        const isUsable = !isRestricted || skillData.ranks > 0;

        const maxRanks = state.level + 3;
        const actualRanks = Math.min(skillData.ranks, maxRanks);

        let keyAbility = 'intelligence';
        if (['Balance', 'Climb', 'Escape Artist', 'Hide', 'Jump', 'Move Silently', 'Open Lock', 'Ride', 'Sleight of Hand', 'Tumble', 'Use Rope'].includes(skill)) {
          keyAbility = 'dexterity';
        } else if (['Intimidate', 'Swim'].includes(skill)) {
          keyAbility = 'strength';
        } else if (['Heal', 'Listen', 'Profession', 'Sense Motive', 'Spot', 'Survival'].includes(skill)) {
          keyAbility = 'wisdom';
        } else if (['Bluff', 'Diplomacy', 'Disguise', 'Gather Information', 'Perform', 'Use Magic Device'].includes(skill)) {
          keyAbility = 'charisma';
        }

        const abilityMod = modifiers[keyAbility];
        const total = isUsable ? actualRanks + abilityMod + skillData.misc : '-';

        const div = document.createElement('div');
        div.className = 'skill-item';
        if (isClass) div.style.borderColor = 'rgba(96, 165, 250, 0.5)';
        if (isRestricted) div.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';

        const header = document.createElement('div');
        header.className = 'skill-header';
        const name = document.createElement('span');
        name.textContent = skill;
        const value = document.createElement('span');
        value.className = 'skill-value';
        value.textContent = total;
        if (!isUsable) value.textContent = '🔒';
        header.appendChild(name);
        header.appendChild(value);
        div.appendChild(header);

        if (isUsable) {
          const details = document.createElement('div');
          details.className = 'text-xs text-gray-400 mb-2';
          details.innerHTML = `Ранг: +${actualRanks}<br>Парам: ${abilityMod >= 0 ? '+' : ''}${abilityMod}`;
          if (skillData.misc !== 0) {
            details.innerHTML += `<br>Прочее: ${skillData.misc >= 0 ? '+' : ''}${skillData.misc}`;
          }
          div.appendChild(details);
        }

        const controls = document.createElement('div');
        controls.className = 'skill-controls';
        const minus = document.createElement('button');
        minus.className = 'btn';
        minus.textContent = '-';
        minus.disabled = skillData.ranks === 0;
        minus.addEventListener('click', () => {
          if (skillData.ranks > 0) {
            state.skills[skill].ranks--;
            renderAll();
          }
        });
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 0;
        input.value = skillData.ranks;
        input.style.width = '50px';
        input.style.textAlign = 'center';
        input.disabled = !isUsable && skillData.ranks === 0;
        input.addEventListener('input', (e) => {
          const val = Math.max(0, parseInt(e.target.value) || 0);
          const oldCost = type === 'class' ? skillData.ranks : skillData.ranks * 2;
          const newCost = type === 'class' ? val : val * 2;
          const newUsed = usedPoints - oldCost + newCost;
          if (newUsed <= totalPoints) {
            state.skills[skill].ranks = val;
            renderAll();
          }
        });
        const plus = document.createElement('button');
        plus.className = 'btn';
        plus.textContent = '+';
        plus.disabled = usedPoints >= totalPoints;
        plus.addEventListener('click', () => {
          const oldCost = type === 'class' ? skillData.ranks : skillData.ranks * 2;
          const newCost = type === 'class' ? (skillData.ranks + 1) : (skillData.ranks + 1) * 2;
          if (usedPoints - oldCost + newCost <= totalPoints) {
            state.skills[skill].ranks++;
            renderAll();
          }
        });
        const cost = document.createElement('span');
        cost.className = 'text-xs text-gray-500';
        cost.textContent = type === 'class' ? '1/ранг' : '2/ранг';
        controls.appendChild(minus);
        controls.appendChild(input);
        controls.appendChild(plus);
        controls.appendChild(cost);
        div.appendChild(controls);

        container.appendChild(div);
      });
    }

    function renderFeats() {
      const container = document.getElementById('featsList');
      container.innerHTML = '';
      state.feats.forEach((feat, index) => {
        const div = document.createElement('div');
        div.className = 'item-row';
        const select = document.createElement('select');
        availableFeats.forEach(f => {
          const option = document.createElement('option');
          option.value = f;
          option.textContent = f;
          if (f === feat) option.selected = true;
          select.appendChild(option);
        });
        select.addEventListener('change', (e) => {
          state.feats[index] = e.target.value;
        });
        const btn = document.createElement('button');
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i data-lucide="x"></i>';
        btn.addEventListener('click', () => {
          state.feats.splice(index, 1);
          renderAll();
        });
        div.appendChild(select);
        div.appendChild(btn);
        container.appendChild(div);
      });
    }

    function renderWeapons() {
      const container = document.getElementById('weaponsList');
      container.innerHTML = '';
      state.weapons.forEach((weapon, index) => {
        const div = document.createElement('div');
        div.className = 'item-row';
        const inputs = ['name', 'damage', 'critical'].map(field => {
          const input = document.createElement('input');
          input.value = weapon[field] || '';
          input.placeholder = field;
          input.addEventListener('input', (e) => {
            state.weapons[index][field] = e.target.value;
          });
          return input;
        });
        const strengthBonus = document.createElement('select');
        ['true', 'false'].forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val === 'true' ? 'Сила' : 'Ловкость';
          if (weapon.strengthBonus.toString() === val) option.selected = true;
          strengthBonus.appendChild(option);
        });
        strengthBonus.addEventListener('change', (e) => {
          state.weapons[index].strengthBonus = e.target.value === 'true';
        });
        const attackMisc = document.createElement('input');
        attackMisc.type = 'number';
        attackMisc.value = weapon.attackMisc;
        attackMisc.placeholder = 'Atk Misc';
        attackMisc.addEventListener('input', (e) => {
          state.weapons[index].attackMisc = parseInt(e.target.value) || 0;
        });
        const damageMisc = document.createElement('input');
        damageMisc.type = 'number';
        damageMisc.value = weapon.damageMisc;
        damageMisc.placeholder = 'Dmg Misc';
        damageMisc.addEventListener('input', (e) => {
          state.weapons[index].damageMisc = parseInt(e.target.value) || 0;
        });
        const btn = document.createElement('button');
        btn.className = 'btn btn-danger';
        btn.innerHTML = '<i data-lucide="x"></i>';
        btn.addEventListener('click', () => {
          state.weapons.splice(index, 1);
          renderAll();
        });
        div.append(...inputs, strengthBonus, attackMisc, damageMisc, btn);
        container.appendChild(div);
      });
    }

    function renderInventory() {
      document.getElementById('inventoryHead').value = state.inventory.head;
      document.getElementById('inventoryNeck').value = state.inventory.neck;
      document.getElementById('inventoryBody').value = state.inventory.body;
      document.getElementById('inventoryHands').value = state.inventory.hands;
      document.getElementById('inventoryFeet').value = state.inventory.feet;
      document.getElementById('inventoryOther').value = state.inventory.other;
    }

    function renderNotes() {
      document.getElementById('notes').value = state.notes;
    }

    function renderAll() {
      renderCharInfo();
      renderAbilities();
      renderXP();
      renderSkills();
      renderFeats();
      renderWeapons();
      renderInventory();
      renderNotes();
      lucide.createIcons();
    }

    // === EVENT LISTENERS ===
    document.getElementById('addFeatBtn').addEventListener('click', () => {
      state.feats.push('');
      renderAll();
    });

    document.getElementById('addWeaponBtn').addEventListener('click', () => {
      state.weapons.push({ name: '', damage: '', critical: '', strengthBonus: true, attackMisc: 0, damageMisc: 0 });
      renderAll();
    });

    document.getElementById('addInventoryBtn').addEventListener('click', () => {
      // Just focus on "Other" field
      document.getElementById('inventoryOther').focus();
    });

    document.getElementById('inventoryHead').addEventListener('input', (e) => { state.inventory.head = e.target.value; });
    document.getElementById('inventoryNeck').addEventListener('input', (e) => { state.inventory.neck = e.target.value; });
    document.getElementById('inventoryBody').addEventListener('input', (e) => { state.inventory.body = e.target.value; });
    document.getElementById('inventoryHands').addEventListener('input', (e) => { state.inventory.hands = e.target.value; });
    document.getElementById('inventoryFeet').addEventListener('input', (e) => { state.inventory.feet = e.target.value; });
    document.getElementById('inventoryOther').addEventListener('input', (e) => { state.inventory.other = e.target.value; });
    document.getElementById('notes').addEventListener('input', (e) => { state.notes = e.target.value; });

    // === INIT ===
    renderAll();
  </script>
</body>
</html>